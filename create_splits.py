# -*- coding: utf-8 -*-
"""create_splits.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bxyMzXPZMpV8Di8topOuZIix9_CQSNod
"""

# notebook to run the json_process.sh process for all preproced datasets
from google.colab import drive
drive.mount("/content/drive", force_remount=False)

import os
import sys
import subprocess

# Commented out IPython magic to ensure Python compatibility.
# %%bash
# set -euo pipefail
# 
# cd /content
# rm -rf AdaBrain-Bench
# git clone --depth 1 https://github.com/iroblesrazzaq/AdaBrain-Bench.git
# cd AdaBrain-Bench
# ls

# Commented out IPython magic to ensure Python compatibility.
# %cd /content/AdaBrain-Bench/
# %pwd
! git pull
! git log

data_root = "/content/drive/MyDrive/AdaBrain-Bench Data"
repo_root = "/content/AdaBrain-Bench"

import glob, os
def count_pkls(root):
    return len(glob.glob(os.path.join(root, "**", "*.pkl"), recursive=True))

print("Siena:", count_pkls("/content/drive/MyDrive/AdaBrain-Bench Data/Siena/processed_data"))
print("BCI-IV-2A:", count_pkls("/content/drive/MyDrive/AdaBrain-Bench Data/BCI-IV-2A/processed_data"))

DATASETS = ["EEGMAT", "BCI-IV-2A", "HMC", "SHU", "TUEV", "Siena"]
import os, sys, subprocess

DATASETS_LEFT = ["Siena", "TUEV"]
DATASETS_LEFT = ['Siena']
for d in DATASETS_LEFT:
    d_path = os.path.join(repo_root, "preprocessing", d)
    cross_script = os.path.join(d_path, "cross_json_process.py")
    multi_script = os.path.join(d_path, "multi_json_process.py")
    processed_dir = os.path.join(data_root, d, "processed_data")

    if not os.path.exists(processed_dir):
        print(f"[skip] {d}: missing {processed_dir}")
        continue

    if os.path.exists(cross_script):
        print(f"[{d}] cross...")
        subprocess.run([sys.executable, cross_script, data_root], check=True)

    if os.path.exists(multi_script):
        print(f"[{d}] multi...")
        subprocess.run([sys.executable, multi_script, data_root], check=True)

    bash_script = r"""
    set -euo pipefail
    SRC="/content/preprocessing"
    DST="/content/drive/MyDrive/AdaBrain-Bench Data/preprocessing"
    mkdir -p "$DST"
    rsync -av "$SRC/" "$DST/"
    echo "Copied to: $DST"
    """
    subprocess.run(["bash", "-lc", bash_script], check=True)

print("Done.")

# Commented out IPython magic to ensure Python compatibility.
# %%bash
# set -euo pipefail
# python3 /content/AdaBrain-Bench/preprocessing/TUEV/cross_json_process.py \
#   "/content/drive/MyDrive/AdaBrain-Bench Data"
#

bash_script = r"""
set -euo pipefail
SRC="/content/preprocessing"
DST="/content/drive/MyDrive/AdaBrain-Bench Data/preprocessing"
mkdir -p "$DST"
rsync -av "$SRC/" "$DST/"
echo "Copied to: $DST"
"""
subprocess.run(["bash", "-lc", bash_script], check=True)

# Commented out IPython magic to ensure Python compatibility.
# %cd /content/drive/MyDrive/AdaBrain-Bench Data
# %cd Siena/

os.listdir()

import glob, os
root = "/content/drive/MyDrive/AdaBrain-Bench Data/Siena/processed_data"
print("PN folders:", len([d for d in os.listdir(root) if d.startswith("PN")]))
print("PKLs:", len(glob.glob(os.path.join(root, "PN*", "*.pkl"))))

import os, re, shutil

root = "/content/drive/MyDrive/AdaBrain-Bench Data/Siena/processed_data"
for fname in os.listdir(root):
    if not fname.endswith(".pkl"):
        continue
    m = re.match(r"(PN\d{2})", fname)
    if not m:
        print("skip:", fname)
        continue
    pid = m.group(1)
    dst_dir = os.path.join(root, pid)
    os.makedirs(dst_dir, exist_ok=True)
    shutil.move(os.path.join(root, fname), os.path.join(dst_dir, fname))

import os, glob
root = "/content/drive/MyDrive/AdaBrain-Bench Data/Siena/processed_data"
print("PN dirs:", len([d for d in os.listdir(root) if d.startswith("PN") and os.path.isdir(os.path.join(root, d))]))
print("PKLs:", len(glob.glob(os.path.join(root, "PN*", "*.pkl"))))

import os, re, shutil

root = "/content/drive/MyDrive/AdaBrain-Bench Data/Siena/processed_data"
moved = 0
for fname in os.listdir(root):
    src = os.path.join(root, fname)
    if not (os.path.isfile(src) and fname.endswith(".pkl")):
        continue
    m = re.match(r"(PN\d{2})", fname)
    if not m:
        print("skip:", fname)
        continue
    pid = m.group(1)
    dst_dir = os.path.join(root, pid)
    os.makedirs(dst_dir, exist_ok=True)
    shutil.move(src, os.path.join(dst_dir, fname))
    moved += 1

print("moved:", moved)

# Find any Siena JSONs anywhere on the VM
!find /content -path "*Siena/cross_subject_json/*.json" -ls